---

# 0. 总体设计原则（放在 docs/architecture.md 开头）

## 核心原则

1. **单一可变核心**：只有 `editor` 可以持有可变编辑状态
2. **Action 驱动**：所有用户输入 → Action → Dispatcher
3. **ViewModel 隔离**：editor 永不直接被 GUI / render 访问
4. **自底向上依赖**：禁止反向 import

---

# 1. core 模块设计文档

## 1.1 模块职责

**core 是整个系统的“数学基础”**

* 提供最小、稳定、无副作用的数据结构
* 不包含任何编辑器概念
* 可独立测试、独立复用

## 1.2 允许依赖

* Rust std
* 第三方纯数据结构库（如 ropey）

❌ 禁止依赖 editor / render / gui

## 1.3 子模块说明

### buffer.rs

* 文本存储（Rope）
* 提供 insert / delete / slice
* 不关心 undo / cursor

### cursor.rs

* 光标位置结构
* 不包含移动逻辑（逻辑在 editor / features）

### selection.rs

* 表示选区范围（anchor / caret）

---

# 2. editor 模块设计文档

## 2.1 模块职责

**editor 是“编辑器的心脏”**

* 持有所有可变编辑状态
* 实现编辑操作
* 管理 undo / redo

## 2.2 不变量（非常重要）

* editor 内部状态必须始终一致
* 任意 Action 执行后 editor 必须是合法状态

## 2.3 核心结构

### Editor

* 聚合：

  * Document
  * Cursor / Selection
  * History
* 对外只暴露高层 API

### operation.rs

* 定义最小原子编辑操作
* 是 undo / redo 的最小单位

---

# 3. features 模块设计文档

## 3.1 模块职责

**features = 编辑算法集合**

* 只计算
* 不修改 editor
* 不绘制

## 3.2 设计原则

* 输入：editor / buffer 快照
* 输出：位置 / 范围 / 结果结构
* 可单元测试

### 示例

* bracket_match：返回匹配括号位置
* wrap：返回软换行映射

---

# 4. search 模块设计文档

## 4.1 模块职责

* 查找 / 替换
* 支持正则
* 大文件友好

## 4.2 特点

* 不直接修改 editor
* 返回 match 列表
* 替换操作通过 Action 进入 editor

---

# 5. syntax 模块设计文档

## 5.1 模块职责

**syntax 只负责“解析”，不负责“显示”**

* 文本 → token / scope
* 支持增量更新（未来）

## 5.2 关键约束

* 不直接绑定 theme
* 不依赖 render

---

# 6. theme 模块设计文档

## 6.1 模块职责

* 定义颜色、字体、样式
* 提供统一风格接口

## 6.2 设计原则

* theme 是数据
* style 由 render 解析

---

# 7. render 模块设计文档（重点）

## 7.1 模块职责

**render = 文档 → 像素**

* 不修改 editor
* 不处理输入
* 不持久化状态

## 7.2 核心概念

### EditorViewModel

* editor 的只读投影
* GUI / render 的唯一输入

### layout.rs

* 字符 → 屏幕位置
* 处理软换行 / 字体度量

### gutter.rs

* 行号绘制
* 当前行高亮
* 不处理点击

---

# 8. gui 模块设计文档

## 8.1 模块职责

* 组织 egui 组件
* 不包含编辑逻辑

## 8.2 editor_view 子模块

### editor_view.rs

* 编辑器视图组合器
* 管理绘制顺序

### input_mapper.rs

* 鼠标坐标 → Action
* GUI 中唯一处理点击语义的地方

---

# 9. input 模块设计文档

## 9.1 模块职责

* 键盘 / 鼠标事件处理
* 映射为 Action

## 9.2 关键设计

* 不直接调用 editor
* 快捷键配置可热加载

---

# 10. app 模块设计文档（调度核心）

## 10.1 模块职责

**app 是“系统中枢”**

* 生命周期
* 状态恢复
* Action 调度

## 10.2 dispatcher.rs

* Action → Command
* Command → editor / io / app

---

# 11. io 模块设计文档

## 11.1 模块职责

* 文件打开 / 保存
* mmap 支持
* 外部修改监听

---

# 12. encoding 模块设计文档

## 12.1 模块职责

* 编码检测
* 解码 / 编码转换

---

# 13. i18n 模块设计文档

## 13.1 模块职责

* 多语言支持
* UI 文本统一管理

---
