---

# 0️⃣ 通用约定（所有模块通用）

### 目录约定

* 每个模块：

  * `mod.rs` 只做 re-export
  * 逻辑写在子文件
* **所有 struct 默认私有字段**
* 对外只暴露 trait / 方法

---

# 1️⃣ core 模块

## core/mod.rs

```rust
pub mod buffer;
pub mod position;
pub mod cursor;
pub mod selection;
```

---

## core/position.rs

```rust
#[derive(Debug, Clone, Copy, PartialEq, Eq)]
pub struct Point {
    pub line: usize,
    pub column: usize,
}

#[derive(Debug, Clone, Copy, PartialEq, Eq)]
pub struct Range {
    pub start: usize,
    pub end: usize,
}
```

---

## core/buffer.rs

```rust
use ropey::Rope;

pub struct Buffer {
    rope: Rope,
}

impl Buffer {
    pub fn new() -> Self {
        Self { rope: Rope::new() }
    }

    pub fn from_str(text: &str) -> Self {
        Self { rope: Rope::from_str(text) }
    }

    pub fn insert(&mut self, byte_idx: usize, text: &str) {
        self.rope.insert(byte_idx, text);
    }

    pub fn delete(&mut self, range: std::ops::Range<usize>) {
        self.rope.remove(range);
    }

    pub fn text(&self) -> String {
        self.rope.to_string()
    }
}
```

---

## core/cursor.rs

```rust
use crate::position::Point;

#[derive(Debug, Clone)]
pub struct Cursor {
    pub position: Point,
}
```

---

## core/selection.rs

```rust
use crate::position::Range;

#[derive(Debug, Clone)]
pub struct Selection {
    pub range: Option<Range>,
}
```

---

# 2️⃣ editor 模块（核心）

## editor/mod.rs

```rust
pub mod editor;
pub mod document;
pub mod history;
pub mod operation;
```

---

## editor/editor.rs

```rust
use crate::core::{buffer::Buffer, cursor::Cursor, selection::Selection};

pub struct Editor {
    buffer: Buffer,
    cursor: Cursor,
    selection: Selection,
}

impl Editor {
    pub fn new() -> Self {
        Self {
            buffer: Buffer::new(),
            cursor: Cursor { position: crate::core::position::Point { line: 0, column: 0 } },
            selection: Selection { range: None },
        }
    }

    pub fn insert_text(&mut self, text: &str) {
        // TODO: record history
        let offset = 0;
        self.buffer.insert(offset, text);
    }

    pub fn snapshot(&self) -> EditorSnapshot {
        EditorSnapshot {
            text: self.buffer.text(),
        }
    }
}

pub struct EditorSnapshot {
    pub text: String,
}
```

---

## editor/operation.rs

```rust
pub trait EditorOperation {
    fn apply(&mut self, editor: &mut crate::editor::editor::Editor);
    fn undo(&mut self, editor: &mut crate::editor::editor::Editor);
}
```

---

## editor/history.rs

```rust
use super::operation::EditorOperation;

pub struct History {
    undo_stack: Vec<Box<dyn EditorOperation>>,
    redo_stack: Vec<Box<dyn EditorOperation>>,
}
```

---

# 3️⃣ features 模块（纯算法）

## features/mod.rs

```rust
pub mod bracket_match;
```

---

## features/bracket_match.rs

```rust
pub fn find_matching(text: &str, pos: usize) -> Option<usize> {
    // TODO
    None
}
```

---

# 4️⃣ search 模块

## search/mod.rs

```rust
pub mod searcher;
pub mod replacer;
```

---

## search/searcher.rs

```rust
use crate::core::position::Range;

pub fn find_all(text: &str, pattern: &str) -> Vec<Range> {
    // TODO
    Vec::new()
}
```

---

## search/replacer.rs

```rust
pub fn replace_all(text: &str, from: &str, to: &str) -> String {
    text.replace(from, to)
}
```

---

# 5️⃣ syntax 模块

## syntax/mod.rs

```rust
pub mod token;
pub mod parser;
```

---

## syntax/token.rs

```rust
#[derive(Debug, Clone)]
pub struct Token {
    pub text: String,
    pub kind: TokenKind,
}

#[derive(Debug, Clone, Copy)]
pub enum TokenKind {
    Keyword,
    String,
    Comment,
    Plain,
}
```

---

## syntax/parser.rs

```rust
use super::token::Token;

pub trait SyntaxParser {
    fn parse(&self, text: &str) -> Vec<Token>;
}
```

---

# 6️⃣ theme 模块

## theme/mod.rs

```rust
pub mod theme;
```

---

## theme/theme.rs

```rust
use std::collections::HashMap;
use crate::syntax::token::TokenKind;

#[derive(Clone)]
pub struct Theme {
    pub background: (u8, u8, u8),
    pub foreground: (u8, u8, u8),
    pub syntax: HashMap<TokenKind, (u8, u8, u8)>,
}
```

---

# 7️⃣ render 模块（只读）

## render/mod.rs

```rust
pub mod view_model;
pub mod renderer;
pub mod gutter;
```

---

## render/view_model.rs

```rust
pub struct EditorViewModel {
    pub text: String,
    pub show_line_numbers: bool,
}
```

---

## render/gutter.rs

```rust
use crate::render::view_model::EditorViewModel;

pub struct Gutter;

impl Gutter {
    pub fn paint(&self, vm: &EditorViewModel) {
        if !vm.show_line_numbers {
            return;
        }
        // TODO: draw line numbers
    }
}
```

---

## render/renderer.rs

```rust
use crate::render::view_model::EditorViewModel;

pub struct Renderer;

impl Renderer {
    pub fn render(&self, vm: &EditorViewModel) {
        // draw text
    }
}
```

---

# 8️⃣ gui 模块

## gui/mod.rs

```rust
pub mod editor_view;
```

---

## gui/editor_view.rs

```rust
use crate::render::{renderer::Renderer, gutter::Gutter};

pub struct EditorView {
    renderer: Renderer,
    gutter: Gutter,
}

impl EditorView {
    pub fn draw(&self, vm: &crate::render::view_model::EditorViewModel) {
        self.gutter.paint(vm);
        self.renderer.render(vm);
    }
}
```

---

# 9️⃣ input 模块

## input/mod.rs

```rust
pub mod action;
pub mod keyboard;
```

---

## input/action.rs

```rust
pub enum Action {
    InsertChar(char),
    Save,
    Quit,
}
```

---

## input/keyboard.rs

```rust
use super::action::Action;

pub fn handle_key(key: char) -> Option<Action> {
    Some(Action::InsertChar(key))
}
```

---
