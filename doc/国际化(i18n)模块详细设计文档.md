# 国际化(i18n)模块详细设计文档

## 1. 概述

### 1.1 设计目标

为REditor提供完整的多语言支持，支持运行时中英文切换，为未来扩展其他语言奠定基础。

### 1.2 核心特性

- ✅ **运行时语言切换**：无需重启应用即可切换语言
- ✅ **类型安全**：使用枚举定义语言和翻译键，避免字符串错误
- ✅ **易于扩展**：添加新语言只需添加翻译数据
- ✅ **性能优化**：O(1) 翻译查找，启动时预加载
- ✅ **全局访问**：提供便捷的全局访问函数

## 2. 架构设计

### 2.1 模块结构

```rust
src/
├── i18n/                      # 国际化模块
│   ├── mod.rs                # 模块入口和导出
│   ├── manager.rs            # 翻译管理器核心逻辑
│   ├── languages.rs          # 语言类型定义
│   ├── translations.rs       # 翻译数据存储
│   └── constants.rs          # 翻译键常量定义
```

### 2.2 核心组件

#### 2.2.1 语言类型 (Language)

```rust
pub enum Language {
    ChineseSimplified,  // 简体中文 (zh-CN)
    English,            // 英文 (en-US)
    // 未来扩展:
    // Japanese,         // 日文 (ja-JP)
    // Korean,           // 韩文 (ko-KR)
    // German,           // 德文 (de-DE)
    // French,           // 法文 (fr-FR)
    // Spanish,          // 西班牙文 (es-ES)
}
```

#### 2.2.2 翻译键 (TranslationKey)

使用枚举定义所有UI字符串，确保类型安全：

**菜单类**

- `MenuFile`, `MenuEdit`, `MenuView`

**文件操作**

- `FileOpen`, `FileSave`, `FileExit`, `FileNew`

**编辑操作**

- `EditUndo`, `EditRedo`, `EditCut`, `EditCopy`, `EditPaste`

**工具栏**

- `ToolbarOpen`, `ToolbarSave`, `ToolbarUndo`, `ToolbarRedo`, `ToolbarFind`

**状态栏**

- `StatusLine`, `StatusColumn`, `StatusEncoding`, `StatusFileType`, `StatusReady`

**对话框**

- `DialogOpenTitle`, `DialogSaveTitle`, `DialogFilterAll`, `DialogFilterText`

**通用**

- `Yes`, `No`, `OK`, `Cancel`, `Confirm`, `Warning`, `Error`

#### 2.2.3 翻译管理器 (I18nManager)

```rust
pub struct I18nManager {
    current_lang: Language,
    translations: HashMap<Language, HashMap<TranslationKey, String>>,
}

impl I18nManager {
    /// 创建新的翻译管理器
    pub fn new() -> Self;
    
    /// 获取当前翻译
    pub fn translate(&self, key: TranslationKey) -> String;
    
    /// 设置当前语言
    pub fn set_current_language(&mut self, lang: Language);
    
    /// 获取当前语言
    pub fn get_current_language(&self) -> Language;
    
    /// 获取支持的语言列表
    pub fn get_supported_languages(&self) -> Vec<Language>;
    
    /// 语言描述（用于UI显示）
    pub fn get_language_name(&self, lang: Language) -> String;
}
```

### 2.3 全局访问机制

#### 2.3.1 单例模式

```rust
static I18N: OnceLock<Mutex<I18nManager>> = OnceLock::new();
```

#### 2.3.2 快捷函数

```rust
/// 快速翻译函数
pub fn t(key: TranslationKey) -> String;

/// 设置语言
pub fn set_language(lang: Language);

/// 获取当前语言
pub fn get_language() -> Language;

/// 获取语言名称（用于UI显示）
pub fn get_language_name(lang: Language) -> String;
```

## 3. 翻译数据管理

### 3.1 数据结构

```rust
// 简体中文
let zh_cn = hashmap! {
    TranslationKey::MenuFile => "文件",
    TranslationKey::FileOpen => "打开",
    TranslationKey::StatusLine => "行",
    // ...
};

// 英文
let en = hashmap! {
    TranslationKey::MenuFile => "File",
    TranslationKey::FileOpen => "Open",
    TranslationKey::StatusLine => "Ln",
    // ...
};
```

### 3.2 翻译原则

1. **一致性**：相同概念使用相同翻译
2. **简洁性**：UI空间有限，翻译要简洁
3. **文化适配**：考虑目标语言的文化习惯
4. **可扩展性**：为未来功能预留翻译键

## 4. 集成方案

### 4.1 UI层集成

```rust
// 原代码
ui.menu_button("文件", |ui| {
    if ui.button("打开").clicked() {
        // ...
    }
});

// i18n后
ui.menu_button(&t(TranslationKey::MenuFile), |ui| {
    if ui.button(&t(TranslationKey::FileOpen)).clicked() {
        // ...
    }
});
```

### 4.2 状态栏集成

```rust
// 原代码
ui.label("行:1 列:1");
ui.label("UTF-8");
ui.label("就绪");

// i18n后
ui.label(format!("{}:1 {}:1", 
    t(TranslationKey::StatusLine), 
    t(TranslationKey::StatusColumn)
));
ui.label(&t(TranslationKey::StatusEncoding));
ui.label(&t(TranslationKey::StatusReady));
```

### 4.3 语言切换UI

在视图菜单中添加语言切换选项：

```rust
ui.menu_button(&t(TranslationKey::MenuView), |ui| {
    if ui.button("中文 (简体)").clicked() {
        set_language(Language::ChineseSimplified);
    }
    if ui.button("English").clicked() {
        set_language(Language::English);
    }
});
```

## 5. 实施计划

### 5.1 阶段一：基础架构 (1-2小时)

1. 创建 `i18n` 模块目录结构
2. 定义 `Language` 和 `TranslationKey` 枚举
3. 实现 `I18nManager` 核心逻辑
4. 添加全局访问函数和单例机制
5. 编写基础单元测试

### 5.2 阶段二：UI集成 (2-3小时)

1. 在 `main_window.rs` 中替换所有硬编码字符串
2. 在 `editor_view.rs` 中替换状态栏文本
3. 添加语言切换菜单项
4. 测试中英文切换功能

### 5.3 阶段三：测试优化 (1小时)

1. 验证所有UI元素正确显示
2. 测试语言切换的流畅性
3. 检查内存使用和性能
4. 修复边界情况和错误

## 6. 扩展性考虑

### 6.1 未来语言扩展

添加新语言只需：

```rust
// 1. 在 Language 枚举中添加新语言
pub enum Language {
    // ...
    Japanese,
}

// 2. 在 translations.rs 中添加翻译数据
let ja = hashmap! {
    TranslationKey::MenuFile => "ファイル",
    // ...
};

// 3. 更新支持语言列表
translations.insert(Language::Japanese, ja);
```

### 6.2 高级功能（未来可选）

- **动态加载**：从JSON文件或网络加载翻译
- **复数形式**：处理不同语言的复数规则
- **变量插值**：支持带参数的翻译（如 "打开 {0} 个文件"）
- **日期时间本地化**：不同语言的日期格式
- **RTL支持**：为阿拉伯语等从右到左的语言支持

## 7. 性能考虑

### 7.1 时间复杂度

- 翻译查询：O(1) 哈希查找
- 语言切换：O(1) 仅修改当前语言标记

### 7.2 空间复杂度

- 翻译数据：O(N×M)，N=语言数量，M=翻译键数量
- 单例开销：可忽略

### 7.3 优化策略

1. **启动时加载**：所有翻译数据在启动时加载到内存
2. **懒加载**：如果未来支持动态加载，可按需加载
3. **缓存**：频繁使用的翻译可缓存结果

## 8. 测试策略

### 8.1 单元测试

```rust
#[test]
fn test_translation() {
    set_language(Language::ChineseSimplified);
    assert_eq!(t(TranslationKey::MenuFile), "文件");
    
    set_language(Language::English);
    assert_eq!(t(TranslationKey::MenuFile), "File");
}

#[test]
fn test_language_switch() {
    set_language(Language::ChineseSimplified);
    assert_eq!(get_language(), Language::ChineseSimplified);
    
    set_language(Language::English);
    assert_eq!(get_language(), Language::English);
}
```

### 8.2 集成测试

- 验证所有UI元素使用翻译函数
- 测试语言切换后UI立即更新
- 验证特殊字符和Unicode支持

### 8.3 边界测试

- 翻译键不存在时的回退行为
- 空字符串处理
- 超长翻译文本的UI适应性

## 9. 文档和维护

### 9.1 翻译键管理

- 维护 `TranslationKey` 枚举的文档
- 新增功能时必须同时添加翻译键
- 定期审核翻译一致性

### 9.2 翻译质量

- 建立翻译审核流程
- 收集用户反馈
- 定期更新翻译

### 9.3 版本控制

- 翻译数据随代码一起版本控制
- 重大翻译更新记录在CHANGELOG中

## 10. 风险和缓解

### 10.1 风险

1. **翻译遗漏**：新功能忘记添加翻译
2. **UI布局问题**：不同语言长度差异导致UI错乱
3. **性能问题**：大量翻译数据影响启动时间

### 10.2 缓解措施

1. **代码审查**：确保所有UI字符串使用翻译函数
2. **自适应UI**：使用Flex布局，支持文本换行
3. **性能测试**：监控启动时间和内存使用
4. **自动化检查**：添加lint规则检查硬编码字符串

## 11. 总结

### 11.1 设计优势

- ✅ **类型安全**：编译时检查翻译键
- ✅ **易于维护**：集中管理所有翻译
- ✅ **性能优秀**：高效的查找机制
- ✅ **扩展性强**：易于添加新语言
- ✅ **用户体验**：运行时切换，无需重启

### 11.2 实施价值

- 为国际化用户群体打下基础
- 提升产品专业度
- 便于未来商业化推广
- 体现对用户体验的重视

### 11.3 后续建议

1. 完成核心编辑功能后立即实施
2. 建立翻译贡献指南
3. 考虑社区翻译支持
4. 定期更新和优化翻译质量

---

**文档版本**: v1.0  
**创建日期**: 2025-12-30  
**作者**: REditor开发团队  
**状态**: 设计完成，待实施
