# Syntect å¢é‡é«˜äº®å·¥ç¨‹å®ç°æ–‡æ¡£

> æœ¬æ–‡æ¡£å®šä¹‰åœ¨ Rust + egui + Ropey æ¶æ„ä¸‹ï¼Œ  
> ä½¿ç”¨ Syntect å®ç° **é«˜æ€§èƒ½ã€å¯æ‰©å±•ã€å¯æ§çš„å¢é‡è¯­æ³•é«˜äº®æ–¹æ¡ˆ**ã€‚

---

## ä¸€ã€æ ¸å¿ƒè®¾è®¡ç›®æ ‡

### 1.1 ä¸ºä»€ä¹ˆå¿…é¡»â€œå¢é‡â€

- æ–‡æ¡£å¯èƒ½åŒ…å«ç™¾ä¸‡è¡Œ
- egui æ¯å¸§é‡ç»˜
- Syntect çš„è§£ææˆæœ¬ä¸å¯å¿½ç•¥

> **åŸåˆ™ï¼šæ°¸è¿œåªä¸ºâ€œæ­£åœ¨çœ‹â€çš„å†…å®¹ä»˜å‡ºä»£ä»·ã€‚**

---

## äºŒã€Syntect åœ¨æœ¬é¡¹ç›®ä¸­çš„è§’è‰²

### 2.1 Syntect è´Ÿè´£ä»€ä¹ˆ

- è¯æ³•åˆ†æ
- Scope æ ‘ç”Ÿæˆ
- é«˜äº®çŠ¶æ€æ¨è¿›ï¼ˆParseStateï¼‰

### 2.2 Syntect ä¸è´Ÿè´£ä»€ä¹ˆ

- UI æ¸²æŸ“
- è¡Œç¼“å­˜ç®¡ç†
- æ–‡ä»¶çº§çŠ¶æ€ç®¡ç†

---

## ä¸‰ã€é«˜äº®æ¶æ„æ€»è§ˆ

Document
â””â”€â”€ HighlightManager
â”œâ”€â”€ SyntaxSet
â”œâ”€â”€ Theme
â”œâ”€â”€ LineStateCache
â””â”€â”€ IncrementalEngine

yaml
å¤åˆ¶ä»£ç 

---

## å››ã€æ ¸å¿ƒæ•°æ®ç»“æ„è®¾è®¡

### 4.1 æŠ½è±¡ Tokenï¼ˆå›é¡¾ï¼‰

```rust
pub enum HighlightToken {
    Keyword,
    String,
    Comment,
    Number,
    Type,
    Function,
    Plain,
}
4.2 è¡Œçº§é«˜äº®ç¼“å­˜
rust
å¤åˆ¶ä»£ç 
pub struct HighlightedLine {
    pub spans: Vec<(HighlightToken, Range<usize>)>,
    pub end_state: syntect::parsing::ParseState,
}
end_state æ˜¯ å¢é‡é«˜äº®çš„ç”Ÿå‘½çº¿

4.3 è¡Œç¼“å­˜å®¹å™¨
rust
å¤åˆ¶ä»£ç 
pub struct LineStateCache {
    lines: HashMap<usize, HighlightedLine>,
}
äº”ã€å¢é‡é«˜äº®çš„åŸºæœ¬æ€æƒ³ï¼ˆæé‡è¦ï¼‰
5.1 Syntect çš„æ ¸å¿ƒæœºåˆ¶
Syntect çš„è¯­æ³•è§£ææ˜¯ çŠ¶æ€æœºé©±åŠ¨çš„ï¼š

mathematica
å¤åˆ¶ä»£ç 
Line N ParseState
   â†“
è§£æ Line N
   â†“
ç”Ÿæˆ Line N+1 ParseState
ğŸ‘‰ æ¯ä¸€è¡Œçš„é«˜äº®çŠ¶æ€ï¼Œä¾èµ–ä¸Šä¸€è¡Œçš„ ParseState

5.2 å…³é”®ç»“è®º
åªè¦ä½ çŸ¥é“â€œä¸Šä¸€è¡Œçš„çŠ¶æ€â€ï¼Œä½ å°±èƒ½æ­£ç¡®é«˜äº®ä¸‹ä¸€è¡Œ

å…­ã€å¯è§è¡Œé«˜äº®æµç¨‹ï¼ˆä¸»è·¯å¾„ï¼‰
6.1 è·å–é«˜äº®æ•°æ®
text
å¤åˆ¶ä»£ç 
è¯·æ±‚ç¬¬ N è¡Œé«˜äº®
 â†’ æŸ¥ç¼“å­˜
 â†’ å‘½ä¸­ï¼šç›´æ¥è¿”å›
 â†’ æœªå‘½ä¸­ï¼š
      æ‰¾æœ€è¿‘çš„å·²çŸ¥ ParseState
      å‘å‰æ¨è¿›
      ç”Ÿæˆå¹¶ç¼“å­˜
6.2 æœ€è¿‘çŠ¶æ€å›æº¯ç­–ç•¥
text
å¤åˆ¶ä»£ç 
Line 100 è¯·æ±‚
ç¼“å­˜æœ‰ï¼š
  Line 80 end_state
 â†’ ä» 80 æ¨è¿›åˆ° 100
çº¦æŸï¼š

æœ€å¤§å›æº¯è¡Œæ•°ï¼ˆå¦‚ 100ï¼‰

è¶…è¿‡åˆ™é™çº§ä¸ºæ— é«˜äº®

ä¸ƒã€ç¼–è¾‘åçš„å¤±æ•ˆä¸é‡ç®—ç­–ç•¥
7.1 å“ªäº›ä¿®æ”¹ä¼šå½±å“é«˜äº®
ä¿®æ”¹ç±»å‹	å½±å“
æ’å…¥å­—ç¬¦	å½“å‰è¡ŒåŠä¹‹å
åˆ é™¤å­—ç¬¦	å½“å‰è¡ŒåŠä¹‹å
åˆ é™¤æ¢è¡Œ	å½“å‰è¡ŒåŠä¹‹å

7.2 å¤±æ•ˆèŒƒå›´æ§åˆ¶
text
å¤åˆ¶ä»£ç 
ä¿®æ”¹å‘ç”Ÿåœ¨ Line K
 â†’ invalidate K
 â†’ invalidate K+1 ...
 â†’ ç›´åˆ° ParseState æ”¶æ•›
æ”¶æ•›æ¡ä»¶ï¼š

æ–° ParseState == æ—§ ParseState

å…«ã€ä¸ egui æ¸²æŸ“çš„å¯¹æ¥
8.1 ä» HighlightedLine åˆ° LayoutJob
text
å¤åˆ¶ä»£ç 
HighlightToken + Range
 â†’ æŸ¥è¯¢ä¸»é¢˜é¢œè‰²
 â†’ LayoutJob.append()
8.2 ç¼“å­˜ LayoutJobï¼ˆå¯é€‰ï¼‰
rust
å¤åˆ¶ä»£ç 
HashMap<LineIndex, LayoutJob>
å¤±æ•ˆæ¡ä»¶ï¼š

æ–‡æœ¬å˜åŒ–

ä¸»é¢˜å˜åŒ–

é«˜äº®çŠ¶æ€å˜åŒ–

ä¹ã€å¤§æ–‡ä»¶ï¼ˆLarge Bufferï¼‰é™çº§è§„åˆ™
Buffer ç±»å‹	é«˜äº®ç­–ç•¥
Small	å®Œæ•´å¢é‡é«˜äº®
Medium	å¯è§è¡Œå¢é‡
Large	ç¦ç”¨

Large æ–‡ä»¶ï¼š

ä¸åˆ›å»º HighlightManager

ç›´æ¥ä½¿ç”¨å•è‰² Layout

åã€é”™è¯¯ä¸å¼‚å¸¸å¤„ç†
10.1 Syntect å¤±è´¥åœºæ™¯
æœªè¯†åˆ«è¯­æ³•

é UTF-8 æ–‡æœ¬

è§£æ panicï¼ˆæå°‘ï¼‰

10.2 å¤„ç†ç­–ç•¥
å›é€€ Plain Token

ä¿è¯ UI ä¸å´©æºƒ

è®°å½•æ—¥å¿—ä½†ä¸ä¸­æ–­

åä¸€ã€ç¦æ­¢è¡Œä¸ºï¼ˆçº¢çº¿ï¼‰
âŒ æ‰“å¼€æ–‡ä»¶æ—¶å…¨é‡é«˜äº®

âŒ æ¯å¸§å…¨é‡é‡ç®—

âŒ é«˜äº®çŠ¶æ€è·¨ Document å…±äº«

âŒ å¤§æ–‡ä»¶å¯ç”¨ Syntect

åäºŒã€è°ƒè¯•ä¸éªŒè¯æ¸…å•
 å¿«é€Ÿæ»šåŠ¨æ—¶æ— å¡é¡¿

 ä¿®æ”¹ä¸€è¡Œä¸å½±å“å…¨æ–‡

 å¤šè¯­è¨€æ–‡ä»¶æ­£ç¡®é«˜äº®

 é«˜äº®ç¼“å­˜å‘½ä¸­ç‡é«˜

 CPU ä½¿ç”¨ç¨³å®š