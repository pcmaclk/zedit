# Rust + egui + Ropey + Syntect 跨平台文本编辑器开发方案（离线版）

> 目标：Notepad4 风格 / 原生 / 高性能 / 大文件 / 主题 & 高亮 / 高 DPI / 小体积 / 单文件

---

## 一、项目目标与边界

### 1.1 核心目标

* 原生 GUI（非 Web）
* 启动快（<200ms）
* 支持 ≥1GB 大文件流畅滚动
* 高质量字体渲染（支持等宽字体）
* 高 DPI / 多显示器支持
* 多标签编辑
* 亮/暗主题切换
* 小体积、低内存
* 单可执行文件发布

### 1.2 明确不做

* 富文本 / 富交互控件（初版）
* LSP / IDE 高级功能（初版）
* Electron / Flutter / Web UI
* GPU 特效渲染（保留 egui 默认 GPU）

---

## 二、技术路线总览

| 层级        | 技术选择                     | 说明 |
| ----------- | -------------------------- | --- |
| 主语言       | Rust                        | 控制逻辑、文件 I/O、文本缓冲、命令系统 |
| GUI         | egui / eframe               | Immediate Mode GUI，跨平台、轻量、主题可定制 |
| 文本缓冲     | Ropey                        | 高性能大文件编辑，支持 Undo/Redo，分块 / 虚拟渲染 |
| 语法高亮     | Syntect                     | TextMate / Sublime 风格高亮，可增量渲染 |
| 文件 I/O     | Rust std + memmap2           | 支持大文件分块读取 / 映射，编码转换 UTF-8/UTF-16 |
| 插件 / 扩展  | Lua / Python / WASM（可选） | 提供 API 操作文本缓冲、GUI、文件 |
| 平台         | Windows / Linux / macOS      | 原生窗口、文件路径、剪贴板处理 |
| 配置 / 主题  | TOML / JSON                  | 用户配置、主题文件 |

设计哲学：**Rust 管逻辑 + Ropey 管文本缓冲 + Syntect 管高亮 + egui 管显示和事件**

---

## 三、整体架构设计

┌──────────────────────────┐
│ main.rs │ 程序入口，启动初始化
├──────────────────────────┤
│ App Layer │ 生命周期管理、全局状态
├──────────────────────────┤
│ GUI Layer │ egui / eframe 窗口、菜单、Tab
├──────────────────────────┤
│ Editor Abstraction │ 文本命令、文档管理、Undo/Redo
├──────────────────────────┤
│ Text Buffer Layer │ Ropey 管理大文件文本缓冲
├──────────────────────────┤
│ Syntax Highlight Layer │ Syntect，高亮可见行
├──────────────────────────┤
│ File I/O Layer │ 文件打开/保存、编码、mmap
├──────────────────────────┤
│ Plugin / Extension │ 可选 Lua / Python / WASM
└──────────────────────────┘


**关键原则：**

* GUI 只负责显示和事件
* Ropey 管文本数据，支持大文件
* Syntect 只处理高亮，不管理文本
* 文件 I/O 层与文本缓冲解耦
* 插件扩展异步执行，避免阻塞主循环

---

## 四、目录结构

editor/
├─ Cargo.toml
├─ src/
│ ├─ main.rs
│ ├─ app/
│ │ ├─ app.rs
│ │ ├─ command.rs
│ │ ├─ config.rs
│ │ └─ session.rs
│ ├─ gui/
│ │ ├─ main_window.rs
│ │ ├─ menu.rs
│ │ └─ dialogs.rs
│ ├─ editor/
│ │ ├─ editor.rs
│ │ ├─ document.rs
│ │ ├─ buffer.rs
│ │ ├─ search.rs
│ │ ├─ theme.rs
│ │ └─ lexer.rs
│ ├─ io/
│ │ ├─ file.rs
│ │ └─ mmap.rs
│ └─ plugin/
│ ├─ lua.rs
│ └─ wasm.rs
├─ resources/
│ ├─ themes/
│ ├─ icons/
│ └─ defaults/
└─ docs/
├─ architecture.md
└─ decisions.md


---

## 五、运行流程

### 5.1 启动流程

main.rs
↓
App::init()
↓
加载配置 / DPI 初始化
↓
创建 egui 主窗口
↓
初始化 Tab 管理
↓
创建第一个文档 / Editor
↓
进入事件循环


### 5.2 打开文件流程

菜单 / 快捷键
↓
App.command.open_file()
↓
Buffer 层决定加载策略（全量 / 分块 / mmap）
↓
Document 初始化
↓
Ropey 填充可编辑文本
↓
Syntect 高亮可见行
↓
GUI 渲染显示


### 5.3 编辑与输入流程

用户输入 / 粘贴
↓
Ropey 更新 Buffer
↓
Document 状态更新（dirty、光标）
↓
Syntect 增量高亮可见行
↓
GUI 虚拟渲染（只渲染可见行）


### 5.4 保存文件流程


命令触发
↓
Document.save()
↓
Buffer 提供文本
↓
File I/O 写入磁盘
↓
更新 dirty 状态


---

## 六、文本缓冲与大文件策略

### 6.1 Buffer 层职责

* 管理文本内容
* 支持 Undo/Redo
* 提供可见行 / 切片给 GUI 和高亮层
* 管理大文件加载策略

### 6.2 文件大小策略

| 文件大小     | 加载方式                  | 可编辑 | 说明             |
| ------------ | ----------------------- | ------ | ---------------- |
| 小 (<50MB)   | 全量读取                 | ✅      | 全功能            |
| 中 (50–500MB)| 分块读取 / Ropey append  | ✅      | 降级高亮或分块处理|
| 大 (>500MB)  | mmap 只读 / 分块处理     | ❌      | 只读滚动 / 搜索   |

### 6.3 虚拟渲染 & 高亮优化

* GUI 只渲染可见行
* Syntect 只对可见行增量高亮
* 渲染缓存 Glyph / 行纹理
* 按需刷新 `ctx.request_repaint()`

---

## 七、插件与扩展

* Lua / Python / WASM 插件
* 提供 API 操作：
  - Buffer / Document
  - 文件 I/O
  - GUI 控件
* 异步执行，避免阻塞主循环

---

## 八、性能优化

1. **虚拟渲染**：只绘制屏幕可见行  
2. **增量高亮**：Syntect 只处理修改或可见行  
3. **按需重绘**：静态场景降低 CPU/电量消耗  
4. **缓存 Glyph / 行纹理**  
5. **大文件分块 / mmap**  
6. **FPS 控制**：编辑/滚动高帧率，静止低帧率  

---

## 九、开发计划（甘特表风格）

| 阶段 | 周数 | 任务 |
|------|------|------|
| 前期准备 | 1 | 环境搭建，学习 Ropey / Syntect / egui |
| GUI 架构 | 1–2 | 主窗口，菜单，多标签页，事件 |
| 文本缓冲 | 2–3 | Ropey 集成，插入/删除/Undo/Redo，大文件支持 |
| 语法高亮 | 2–3 | Syntect 集成，增量渲染，主题切换 |
| 文件 I/O & 搜索/替换 | 1–2 | 打开/保存文件，分块读取，查找/替换 |
| 插件系统 | 2 | Lua / Python / WASM 接口 |
| 性能优化 | 2–3 | 虚拟渲染、增量高亮、缓存、FPS 控制 |
| 打包发布 | 1 | Release 构建，去掉调试信息，跨平台测试 |
| 文档 & 测试 | 1–2 | 用户文档、开发文档、单元/集成/性能测试 |

**总周期**：约 12–18 周（3–4 个月）

---

## 十、发布方案

* 跨平台单文件可执行（Windows/Linux/macOS）  
* 文件体积 15–25 MB  
* 打包字体、主题、图标资源  
* Release 构建开启 LTO、去掉调试信息  

---

## 十一、测试策略

* 单元测试：Ropey 操作、Syntect 高亮、文件 I/O  
* 集成测试：GUI + 文本 + 高亮 + 搜索/替换  
* 性能测试：大文件滚动、编辑、CPU/内存监控  
* 移动端（可选）：电量、FPS、虚拟渲染效果  

---

## 十二、总结

* 技术路线：**Rust + egui + Ropey + Syntect**  
* 支持大文件、主题切换、多标签页、高亮  
* 高性能虚拟渲染 + 增量高亮 + 按需重绘  
* 跨平台、小体积、可单文件发布  
* 插件扩展可选，保证未来可扩展性
