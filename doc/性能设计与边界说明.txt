# 性能设计与边界说明

> 本文档用于明确文本编辑器的性能设计目标、约束边界与禁止行为，  
> 防止在后期功能扩展中引入灾难性性能问题。

---

## 一、总体性能目标

### 1.1 核心指标

| 项目 | 目标 |
|----|----|
| 启动时间 | < 200ms |
| 空闲 CPU | < 1% |
| 输入延迟 | < 16ms |
| 滚动帧率 | ≥ 60 FPS |
| 大文件支持 | ≥ 1GB（只读） |

---

## 二、渲染层性能原则（egui）

### 2.1 egui 使用约束

egui 为 **立即模式 UI（IMGUI）**，因此必须遵守以下规则：

**允许：**
- 每帧构建 UI 树
- 每帧绘制可见文本区域

**禁止：**
- 每帧遍历全文文本
- 在 `update()` 中做 I/O
- 在 UI 线程中执行高亮分析

---

### 2.2 虚拟渲染（Virtual Rendering）

**基本原则：**

> 每一帧只渲染「当前可见行 + 少量缓冲行」

```text
┌───────────────────┐
│ 可见起始行        │
│   ↑               │
│   │  只渲染       │
│   │  这些行       │
│   ↓               │
│ 可见结束行        │
└───────────────────┘

实现要求：

根据滚动偏移计算首尾行号

UI 层永远不知道全文行数

不允许一次性生成所有 LayoutJob

三、文本缓冲性能原则（Ropey）
3.1 Rope 使用规范

允许：

按行读取（line()）

按字符区间切片

局部插入 / 删除

禁止：

每帧 to_string()

全文 clone

全量统计（如全文 scan）

3.2 大文件策略（硬边界）
文件大小	模式	行为
< 50MB	全功能	编辑 / Undo / 高亮
50–200MB	降级	编辑 / 禁用部分高亮
> 200MB	只读	无 Undo / 简化高亮

⚠️ >200MB 文件禁止进入可编辑模式

四、语法高亮性能（Syntect）
4.1 高亮范围限制

只允许高亮：

当前可见行

编辑影响的局部行

禁止：

打开文件时全量高亮

每次修改重新解析全文

4.2 高亮缓存策略
行号 → HighlightState


缓存高亮结果

滚动时优先复用

修改行 → 只 invalidate 后续有限行

五、输入与编辑响应
5.1 输入路径
键盘输入
 → Ropey 修改
 → 标记脏行
 → egui 重绘


要求：

输入不触发高亮全量重算

单次输入 ≤ O(log n)

六、禁止行为总表（红线）

❌ UI 线程做文件 I/O

❌ UI 帧内遍历全文

❌ 每帧重新分词高亮

❌ Ropey 全量 clone

❌ 大文件启用 Undo

七、性能回归检查清单

每新增功能，必须确认：

 不增加每帧复杂度

 不引入全文扫描

 不破坏大文件策略


---

# 文档 4：配置文件格式说明  
**（config.md）**

```markdown
# 配置文件格式说明

> 本文档定义编辑器的配置文件结构、字段含义与兼容策略。

---

## 一、配置文件原则

- 使用 **TOML**
- 人类可读
- 向后兼容
- 未识别字段必须忽略

---

## 二、配置文件位置

| 平台 | 路径 |
|----|----|
| Windows | `%APPDATA%/Editor/config.toml` |
| Linux | `~/.config/editor/config.toml` |
| macOS | `~/Library/Application Support/Editor/config.toml` |

---

## 三、配置文件结构

```toml
[editor]
tab_width = 4
use_spaces = true
wrap = true

[ui]
theme = "dark"
font_size = 14

[files]
auto_reload = true
large_file_readonly_mb = 200

四、字段说明
4.1 [editor]
字段	类型	说明
tab_width	int	Tab 宽度
use_spaces	bool	Tab 转空格
wrap	bool	自动换行
4.2 [ui]
字段	类型	说明
theme	string	主题名
font_size	int	字体大小
4.3 [files]
字段	类型	说明
auto_reload	bool	外部修改自动重载
large_file_readonly_mb	int	只读阈值
五、默认配置策略

启动时加载默认配置

用户配置覆盖默认配置

缺失字段自动补默认值

六、兼容性规则

新字段：提供默认值

废弃字段：保留解析但忽略

不允许破坏旧配置


---

# 文档 5：主题与语法高亮规范  
**（theme_and_highlight.md）**

```markdown
# 主题与语法高亮规范

> 本文档定义主题系统结构以及 Syntect Token 到 UI 渲染的映射规则。

---

## 一、主题设计目标

- 清晰、对比合理
- 亮 / 暗主题一致语义
- 不依赖具体语言

---

## 二、主题文件结构

```toml
[base]
background = "#1e1e1e"
foreground = "#d4d4d4"
caret = "#ffffff"
selection = "#264f78"

[token]
keyword = "#569cd6"
string = "#ce9178"
comment = "#6a9955"
number = "#b5cea8"
type = "#4ec9b0"
function = "#dcdcaa"

三、Token 语义定义（抽象层）
Token	含义
keyword	语言关键字
string	字符串
comment	注释
number	数字
type	类型名
function	函数名

⚠️ UI 不直接识别语言 Token

四、Syntect → 抽象 Token 映射
Syntect Scope        → 抽象 Token
keyword.*            → keyword
string.*             → string
comment.*            → comment
constant.numeric.*   → number
entity.name.type.*   → type
entity.name.function → function

五、高亮应用流程
获取可见行
 → Syntect 分析
 → 转换为抽象 Token
 → 查询主题颜色
 → 构建 egui LayoutJob

六、大文件降级规则
文件大小	高亮策略
< 50MB	完整高亮
50–200MB	可见行高亮
> 200MB	仅基础颜色
七、主题扩展规则

新 Token 不影响旧主题

未定义 Token 使用 foreground

主题解析失败回退默认主题